# Release - Publish to npm (Nx monorepo)
#
# Triggered when a GitHub Release is published. Builds all packages
# and publishes them to npm.
#
# Authentication: Uses NPM_TOKEN secret for npm auth. If OIDC provenance
# is configured on the npm org, the --provenance flag will be used.
#
# Prerequisites:
#   1. Create @strata-game-library org on npmjs.com
#   2. Add NPM_TOKEN (automation token) as a repository secret
#   3. Optionally configure OIDC provenance on the npm org
name: Release

on:
  release:
    types: [published]

permissions:
  contents: read
  id-token: write

concurrency:
  group: release
  cancel-in-progress: false

env:
  NODE_VERSION: '22'
  PNPM_VERSION: 9

jobs:
  # ────────────────────────────────────────────────────────────────────
  # Publish all packages to npm
  # ────────────────────────────────────────────────────────────────────
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm nx run-many -t build

      - name: Publish to npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Publish each package individually to handle already-published versions
          PACKAGES=$(pnpm ls -r --depth -1 --json | node -e "
            const data = JSON.parse(require('fs').readFileSync(0, 'utf8'));
            data.forEach(pkg => {
              if (pkg.name && !pkg.private && pkg.path) {
                console.log(pkg.path);
              }
            });
          ")

          FAILED=0
          for PKG_PATH in $PACKAGES; do
            PKG_NAME=$(node -e "console.log(require('$PKG_PATH/package.json').name)")
            PKG_VERSION=$(node -e "console.log(require('$PKG_PATH/package.json').version)")
            echo "::group::Publishing $PKG_NAME@$PKG_VERSION"

            # Check if already published
            if npm view "$PKG_NAME@$PKG_VERSION" version 2>/dev/null; then
              echo "$PKG_NAME@$PKG_VERSION already published, skipping"
              echo "::endgroup::"
              continue
            fi

            # Attempt publish with provenance, fall back without
            if pnpm --filter "$PKG_NAME" publish --access public --no-git-checks --provenance 2>/dev/null; then
              echo "Published $PKG_NAME@$PKG_VERSION with provenance"
            elif pnpm --filter "$PKG_NAME" publish --access public --no-git-checks; then
              echo "Published $PKG_NAME@$PKG_VERSION without provenance"
            else
              echo "::error::Failed to publish $PKG_NAME@$PKG_VERSION"
              FAILED=1
            fi
            echo "::endgroup::"
          done

          if [ "$FAILED" -eq 1 ]; then
            exit 1
          fi
