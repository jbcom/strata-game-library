# Release - Publish to npm (Nx monorepo)
#
# Triggered when a GitHub Release is published. Builds all packages
# and publishes them to npm with OIDC trusted publishing.
#
# Authentication: Pure OIDC — id-token: write provides keyless npm auth
# and Sigstore provenance attestation. No stored tokens required.
# Requires npm 11.5.1+ for trusted publishing support.
#
# Publishes each package individually so failures (version exists,
# no trusted publisher configured, etc.) don't block other packages.
name: Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

concurrency:
  group: release
  cancel-in-progress: false

env:
  NODE_VERSION: '22'
  PNPM_VERSION: 9

jobs:
  # ────────────────────────────────────────────────────────────────────
  # Publish all packages to npm
  # ────────────────────────────────────────────────────────────────────
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'
          cache: 'pnpm'

      - name: Upgrade npm for trusted publishing
        run: npm install -g npm@latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm nx run-many -t build

      - name: Publish packages with OIDC provenance
        run: |
          # Publish each package individually so one failure doesn't block others.
          # Packages without trusted publishing configured or with version conflicts
          # will fail gracefully while the rest still publish.
          failed=()
          succeeded=()

          for pkg_dir in packages/core packages/shaders packages/presets \
                         adapters/r3f adapters/reactylon \
                         plugins/audio-synth plugins/model-synth \
                         plugins/capacitor plugins/react-native plugins/astro; do
            pkg_name=$(node -p "require('./${pkg_dir}/package.json').name")
            pkg_version=$(node -p "require('./${pkg_dir}/package.json').version")

            echo "::group::Publishing ${pkg_name}@${pkg_version}"
            if (cd "${pkg_dir}" && npm publish --access public --provenance 2>&1); then
              echo "✅ ${pkg_name}@${pkg_version} published successfully"
              succeeded+=("${pkg_name}")
            else
              echo "⚠️ ${pkg_name}@${pkg_version} failed to publish (may already exist or lack trusted publisher)"
              failed+=("${pkg_name}")
            fi
            echo "::endgroup::"
          done

          echo ""
          echo "=== Publish Summary ==="
          echo "Succeeded (${#succeeded[@]}): ${succeeded[*]}"
          echo "Failed (${#failed[@]}): ${failed[*]}"

          # Fail the job only if ALL packages failed
          if [ ${#succeeded[@]} -eq 0 ] && [ ${#failed[@]} -gt 0 ]; then
            echo "::error::All packages failed to publish"
            exit 1
          fi
